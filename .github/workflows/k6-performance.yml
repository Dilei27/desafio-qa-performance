name: K6 Performance Suite

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  load-test:
    name: ğŸ§ª Load Test (250 VUs)
    runs-on: ubuntu-latest

    steps:
      - name: â¬‡ï¸ Checkout Repository
        uses: actions/checkout@v3

      - name: âš¡ Setup Node
        uses: actions/setup-node@v3
        with:
          node-version: "18"
          cache: "npm"

      - name: ğŸ“¦ Install Dependencies
        run: npm install

      - name: ğŸŸ¢ Run Load Test
        run: |
          echo "Running Load Test..."
          k6 run --out json=report-load.json tests/load_test.js

      - name: ğŸ“ Generate HTML Report
        run: npm run report

      - name: ğŸ“¤ Upload JSON Report
        uses: actions/upload-artifact@v3
        with:
          name: load-test-json
          path: report-load.json

      - name: ğŸ“¤ Upload HTML Report
        uses: actions/upload-artifact@v3
        with:
          name: load-test-html
          path: reports/summary.html

  spike-test:
    name: ğŸš€ Spike Test (pico)
    runs-on: ubuntu-latest
    needs: load-test

    steps:
      - name: â¬‡ï¸ Checkout Repository
        uses: actions/checkout@v3

      - name: âš¡ Setup Node
        uses: actions/setup-node@v3
        with:
          node-version: "18"
          cache: "npm"

      - name: ğŸ“¦ Install Dependencies
        run: npm install

      - name: ğŸ”¥ Run Spike Test
        run: |
          echo "Running Spike Test..."
          k6 run --out json=report-spike.json tests/spike_test.js

      - name: ğŸ“ Generate HTML Report
        run: npm run report

      - name: ğŸ“¤ Upload JSON Report
        uses: actions/upload-artifact@v3
        with:
          name: spike-test-json
          path: report-spike.json

      - name: ğŸ“¤ Upload HTML Report
        uses: actions/upload-artifact@v4
        with:
          name: spike-test-html
          path: reports/summary.html

  docker-test:
    name: ğŸ³ Docker Reproducibility Check
    runs-on: ubuntu-latest
    needs: [load-test, spike-test]

    steps:
      - name: â¬‡ï¸ Checkout Repository
        uses: actions/checkout@v3

      - name: ğŸ³ Build Docker Image
        run: docker build -t k6-performance .

      - name: â–¶ï¸ Run Dockerized Load Test
        run: docker run k6-performance || true
